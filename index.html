<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê³µê°„ ë¶ˆì¼ì¹˜ ê³¼ì œ (í•˜íŠ¸/ê½ƒ)</title>
<style>
  body{ background:#f7f7fb; font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif; }
  .wrap{ max-width:920px; margin:24px auto; padding:0 12px; }
  .card{ background:#fff; border:1px solid #e6e6ef; border-radius:12px; padding:18px 20px; box-shadow:0 1px 2px rgba(0,0,0,.02); }
  h1{ font-size:22px; margin:0 0 8px; }
  h2{ font-size:18px; margin:12px 0 10px; }
  p{ line-height:1.6; color:#333; }
  .lane{ display:flex; justify-content:space-between; align-items:center; margin:40px 0; border:2px dashed #ccc; border-radius:14px; padding:20px; }
  .slot{ width:120px; height:120px; display:flex; align-items:center; justify-content:center; font-size:72px; }
  .rule{ display:inline-block; padding:6px 12px; border-radius:999px; font-size:14px; font-weight:700; }
  .heart-rule{ background:#ef4444; color:#fff; }
  .flower-rule{ background:#16a34a; color:#fff; }
  .btns{ display:flex; gap:10px; justify-content:center; margin-top:24px; flex-wrap:wrap; }
  .btn{ background:#111; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-size:16px; cursor:pointer; }
  input[type="text"]{ width:260px; padding:10px 12px; border-radius:8px; border:1px solid #d3d3e2; font-size:14px; }
  .muted{ color:#666; font-size:13px; }
</style>
</head>
<body>
<div class="wrap">
<div id="app" class="card"></div>
</div>

<script>
(function(){
  const app = document.getElementById("app");
  let PID = "";
  const TRIALS = 20;
  let index = 0;
  const results = [];

  const SCRIPT_URL = ""; // ì›í•˜ì‹œë©´ ì¶”í›„ êµ¬ê¸€ì‹œíŠ¸ ì „ì†¡ ê°€ëŠ¥

  function render(html){
    app.innerHTML = html;
  }

  function pagePID(){
    render(`
      <h1>í•˜íŠ¸/ê½ƒ ê³µê°„ ë¶ˆì¼ì¹˜ ê³¼ì œ</h1>
      <p>ì°¸ê°€ì IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
      <p><input type="text" id="pid" placeholder="ì˜ˆ: í™ê¸¸ë™"/></p>
      <div class="btns"><button class="btn" id="start">ë‹¤ìŒ</button></div>
    `);
    document.getElementById("start").onclick = () => {
      const v = (document.getElementById("pid").value || "").trim();
      if(!v){ alert("ì°¸ê°€ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      PID = v;
      pageInstr();
    };
  }

  function pageInstr(){
    render(`
      <h2>ì§€ì¹¨</h2>
      <p>í™”ë©´ ì™¼ìª½ ë˜ëŠ” ì˜¤ë¥¸ìª½ì— <strong>í•˜íŠ¸(â¤ï¸)</strong> ë˜ëŠ” <strong>ê½ƒ(ğŸŒ¸)</strong>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
      <ul>
        <li>â¤ï¸ í•˜íŠ¸ â†’ <strong>ë³´ì´ëŠ” ê·¸ ìª½</strong> ë²„íŠ¼</li>
        <li>ğŸŒ¸ ê½ƒ â†’ <strong>ë°˜ëŒ€ìª½</strong> ë²„íŠ¼</li>
      </ul>
      <p>ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ ì„ íƒí•˜ì„¸ìš”.</p>
      <div class="btns"><button class="btn" id="go">ì‹œì‘</button></div>
    `);
    document.getElementById("go").onclick = () => {
      index = 0;
      nextTrial();
    };
  }

  function nextTrial(){
    const stimType = Math.random()<0.5? "heart" : "flower";
    const side = Math.random()<0.5? "L" : "R";
    const shown = stimType==="heart" ? "â¤ï¸" : "ğŸŒ¸";
    const ruleLabel = stimType==="heart" ? "í•˜íŠ¸: ê°™ì€ìª½" : "ê½ƒ: ë°˜ëŒ€ìª½";
    const ruleClass = stimType==="heart" ? "heart-rule" : "flower-rule";

    const correctSide = (stimType==="heart")? side : (side==="L"?"R":"L");
    const correct = (correctSide==="L")? 1 : 2; // 1=ì™¼ìª½ , 2=ì˜¤ë¥¸ìª½

    const start = performance.now();

    render(`
      <h2>ë¬¸í•­ ${index+1} / ${TRIALS}</h2>
      <div class="lane">
        <div class="slot">${side==="L"?shown:""}</div>
        <div class="slot">${side==="R"?shown:""}</div>
      </div>
      <div class="btns">
        <button class="btn" id="left">ì™¼ìª½</button>
        <button class="btn" id="right">ì˜¤ë¥¸ìª½</button>
      </div>
    `);

    document.getElementById("left").onclick = () => finishTrial(1);
    document.getElementById("right").onclick = () => finishTrial(2);

    function finishTrial(resp){
      const rt = performance.now()-start;
      results.push({
        pid: PID,
        qid: `HF_${index+1}`,
        response: resp,
        correct_index: correct,
        correct: (resp===correct),
        rt: rt,
        ts: new Date().toISOString()
      });
      index++;
      if(index<TRIALS) nextTrial();
      else pageEnd();
    }
  }

  function downloadCSV(){
    let csv = "pid;qid;response;correct_index;correct;rt_ms;timestamp\n";
    results.forEach(r=>{
      csv += `${r.pid};${r.qid};${r.response};${r.correct_index};${r.correct};${Math.round(r.rt)};${r.ts}\n`;
    });
    const blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`heart_flower_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 30000);
  }

  function pageEnd(){
    const n=results.length;
    const acc = n? Math.round(results.filter(r=>r.correct).length*100/n):0;
    const meanRT = n? Math.round(results.reduce((s,r)=>s+r.rt,0)/n):NaN;
    render(`
      <h2>ëë‚¬ìŠµë‹ˆë‹¤.</h2>
      <p>ì°¸ê°€ì: <strong>${PID}</strong></p>
      <p>ì •ë‹µë¥ : <strong>${acc}%</strong></p>
      <p>í‰ê·  ë°˜ì‘ì‹œê°„: <strong>${meanRT} ms</strong></p>
      <div class="btns"><button class="btn" id="csv">CSV ë‹¤ìš´ë¡œë“œ</button></div>
      <p class="muted">(í•„ìš”í•˜ë©´ ì„ ìƒë‹˜ì—ê²Œ ì œì¶œí•˜ì„¸ìš”.)</p>
    `);
    document.getElementById("csv").onclick = downloadCSV;
  }

  pagePID();
})();
</script>
</body>
</html>
