<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê³µê°„ ë¶ˆì¼ì¹˜ ê³¼ì œ (í•˜íŠ¸/ê½ƒ, UMD/í”„ë¦¬ë·° í˜¸í™˜)</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:#fafafa; color:#111}
  .wrap{max-width:920px; margin:24px auto; padding:16px}
  .panel{background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
  h1{font-size:22px; margin:0 0 8px}
  .stim-area{position:relative; height:220px; display:flex; align-items:center; justify-content:center}
  .lane{position:relative; width:80%; max-width:560px; height:110px; border-radius:14px; border:2px dashed #ddd; display:flex; align-items:center; justify-content:space-between; padding:0 24px}
  .stim-img{width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:72px}
  .rule{position:absolute; top:-12px; background:#111; color:#fff; padding:6px 12px; border-radius:999px; font-weight:700; font-size:14px}
  .rule.heart{background:#ef4444}
  .rule.flower{background:#16a34a}
  .meta{color:#666; font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>ê³µê°„ ë¶ˆì¼ì¹˜ ê³¼ì œ (í•˜íŠ¸/ê½ƒ)</h1>
    <div id="boot"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/jspsych.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-instructions@1.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-text@1.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@1.2.0"></script>


<script>
(function(){
  const mount = document.getElementById('boot');

  // 0) í•„ìˆ˜ ì „ì—­ ì‹¬ë³¼ ì ê²€ (í”„ë¦¬ë·° ì‹¤íŒ¨ì‹œ ì›ì¸ ì•ˆë‚´)
  const guards = [
    ['jsPsych', window.jsPsych],
    ['jsPsychInstructions', window.jsPsychInstructions],
    ['jsPsychSurveyText', window.jsPsychSurveyText],
    ['jsPsychHtmlButtonResponse', window.jsPsychHtmlButtonResponse],
  ];
  const missing = guards.filter(([name,ref])=>!ref).map(([name])=>name);
  if(missing.length){
    mount.innerHTML = `
      <div style="background:#ffecec;border:1px solid #ffb3b3;color:#a40000;padding:12px 14px;border-radius:8px;">
        <strong>ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨</strong><br>
        ë‹¤ìŒ ì „ì—­ ì‹¬ë³¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${missing.join(', ')}<br>
        - í•™êµë§/í”„ë¡ì‹œì—ì„œ <code>unpkg.com</code> ì°¨ë‹¨ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.<br>
        - ë˜ëŠ” Netlify/GitHub Pagesë¡œ ì˜¬ë ¤ì„œ ì‹¤í–‰í•´ ë³´ì„¸ìš”.<br>
      </div>`;
    return;
  }

  // 1) ì„¤ì •
  const SCRIPT_URL = ""; // (ì„ íƒ) êµ¬ê¸€ ì‹œíŠ¸ Apps Script ì›¹ì•± URL. ë¹„ìš°ë©´ ì „ì†¡ ì•ˆ í•¨.
  const N_TRIALS = 40;
  const CHOICES = ['ì™¼ìª½','ì˜¤ë¥¸ìª½'];
  const nowTs = () => new Date().toISOString();

  // 2) jsPsych ì´ˆê¸°í™”
  const jsP = jsPsych.init({
    on_finish: function(){
      // CSV ìë™ ì €ì¥
      const csv = jsPsych.data.get().csv();
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `heart_flower_${Date.now()}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 30000);
    }
  });

  const timeline = [];

  // 3) ì°¸ê°€ì ID
  timeline.push({
    type: jsPsychSurveyText,
    preamble: '<h3>ì°¸ê°€ì ID</h3><p>ì˜ˆ: 302_í™ê¸¸ë™</p>',
    questions: [{prompt:'Participant ID', name:'pid', required:true}],
    on_finish: data => {
      const pid = (JSON.parse(data.responses).pid || '').trim();
      jsPsych.data.addProperties({ pid });
    }
  });

  // 4) ì§€ì¹¨
  timeline.push({
    type: jsPsychInstructions,
    pages: [
      '<h3>ì§€ì¹¨</h3>'+
      '<p>í™”ë©´ì˜ ì™¼ìª½ ë˜ëŠ” ì˜¤ë¥¸ìª½ì— <strong>í•˜íŠ¸(â¤ï¸)</strong> ë˜ëŠ” <strong>ê½ƒ(ğŸŒ¸)</strong>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>'+
      '<ul><li>í•˜íŠ¸(â¤ï¸): <u>ê·¸ ìª½</u> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</li>'+
      '<li>ê½ƒ(ğŸŒ¸): <u>ë°˜ëŒ€ìª½</u> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</li></ul>'+
      '<p>ê°€ëŠ¥í•˜ë©´ ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ ì‘ë‹µí•˜ì„¸ìš”. (PC: F=ì™¼ìª½, J=ì˜¤ë¥¸ìª½)</p>'
    ],
    show_clickable_nav: true,
    button_label_next: 'ì‹œì‘'
  });

  // 5) ìê·¹ HTML
  function stimHTML(type, side){
    const left  = side==='L' ? `<div class="stim-img">${type==='heart'?'â¤ï¸':'ğŸŒ¸'}</div>` : '<div class="stim-img"></div>';
    const right = side==='R' ? `<div class="stim-img">${type==='heart'?'â¤ï¸':'ğŸŒ¸'}</div>` : '<div class="stim-img"></div>';
    const ruleClass = (type==='heart') ? 'heart' : 'flower';
    const ruleLabel = (type==='heart') ? 'í•˜íŠ¸: ê°™ì€ìª½' : 'ê½ƒ: ë°˜ëŒ€ìª½';
    return `
      <div class="stim-area">
        <div class="rule ${ruleClass}">${ruleLabel}</div>
        <div class="lane">${left}${right}</div>
      </div>`;
  }

  // 6) íŠ¸ë¼ì´ì–¼ êµ¬ì„±
  const trials = [];
  for(let i=0;i<N_TRIALS;i++){
    const stimType = Math.random()<0.5 ? 'heart' : 'flower';
    const side = Math.random()<0.5 ? 'L' : 'R';
    const correctSide = (stimType==='heart') ? side : (side==='L' ? 'R' : 'L');
    const correctIndex = (correctSide==='L') ? 0 : 1; // ë²„íŠ¼ ë°°ì—´ index (0=ì™¼,1=ì˜¤)

    trials.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: stimHTML(stimType, side),
      choices: CHOICES,
      data: { qid:`HF_${(i+1).toString().padStart(2,'0')}`, stim_type:stimType, stim_side:side, correct_index:correctIndex+1 },
      on_load: () => {
        const onKey = (e)=>{
          if(e.key==='f' || e.key==='F') document.querySelector('.jspsych-btn:nth-child(1)')?.click();
          if(e.key==='j' || e.key==='J') document.querySelector('.jspsych-btn:nth-child(2)')?.click();
        };
        window.addEventListener('keydown', onKey, { once:true });
      },
      on_finish: async (data) => {
        const respIdx = data.response;            // 0/1
        const respCode = (respIdx===0?1:2);       // 1=ì™¼, 2=ì˜¤ (ê·œê²©)
        const correct = (respIdx === correctIndex);
        data.response = respCode;
        data.correct = correct;
        data.rt_ms = data.rt;
        data.timestamp = nowTs();

        const pid = jsPsych.data.get().values().find(d=>d.pid)?.pid || '';
        if(SCRIPT_URL){
          try{
            await fetch(SCRIPT_URL, {
              method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ rows: [[pid, data.qid, respCode, data.correct_index, correct, data.rt_ms, data.timestamp]] })
            });
          }catch(err){ /* ì „ì†¡ ì‹¤íŒ¨ ë¬´ì‹œ */ }
        }
      }
    });
  }
  timeline.push(...trials);

  // 7) ì¢…ë£Œ ìš”ì•½
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: () => {
      const t = jsPsych.data.get().filter(d => /^HF_/.test(d.qid||''));
      const acc = t.count() ? t.filter({correct:true}).count()/t.count() : 0;
      const mrt = Math.round(t.select('rt').mean());
      const pid = jsPsych.data.get().values().find(d=>d.pid)?.pid || '';
      return `<h3>ëë‚¬ìŠµë‹ˆë‹¤.</h3>
        <p>ì°¸ê°€ì ID: <strong>${pid}</strong></p>
        <p>ì •ë‹µë¥ : <strong>${Math.round(acc*100)}%</strong></p>
        <p>í‰ê·  ë°˜ì‘ì‹œê°„: <strong>${isFinite(mrt)?mrt:'N/A'} ms</strong></p>
        <p class="meta">CSV ìë™ ë‹¤ìš´ë¡œë“œê°€ ë˜ì§€ ì•Šìœ¼ë©´ íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>`;
    },
    choices: ['ë‹«ê¸°']
  });

  // 8) ì‹¤í–‰
  jsP.run(timeline);
})();
</script>
</body>
</html>
